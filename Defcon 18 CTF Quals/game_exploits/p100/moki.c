#include <stdlib.h>
#include <netinet/in.h>
#include <netinet/ip.h>
#include <netinet/tcp.h>
#include <arpa/inet.h>
#include <pcap/pcap.h>

#define P 15
#define C 15
#define INTERVAL 1800

static const short ports[P] = {
	111,  // portmap
	0x11c1,  // cm/cjd
	0x11c2,  // cm/cmd
	0x06fb,  // delta/deltad
	0x0808,  // deuce/deuced
	0x0771,  // lazrus/lazrus
	0x10f7,  // magic/magicd
	0x1092,  // mymql/mymqld
	0xdead,  // tuco/tucod
	0x1b41,  // wwcd/wwcd
	0x0921,  // nickster/nickd
	0x157c,  // rsatesp/rsatesp
	7890,    // casino
	0x1ca3,  // buddy
	0x2165,  // mdlj
};


int main(int argc, char *argv[])
{
	char errbuf[PCAP_ERRBUF_SIZE];
	size_t counts[C] = {0};
	pcap_t *pcap;
	struct pcap_pkthdr *hdr;
	const u_char *data;
	int i;
	struct iphdr *ip;
	struct tcphdr *tcp;
	time_t old = 0, cur;
	struct in_addr *addr;
	int team = atoi(argv[2]);

	if (!(pcap = pcap_open_offline(argv[1], errbuf))) {
		fprintf(stderr, "[-] %s\n", errbuf);
		return EXIT_FAILURE;
	}

	while (pcap_next_ex(pcap, &hdr, &data) == 1) {

		/* eth */
		if (hdr->caplen < 14) continue;
		if ((data[12] != 0x08) || (data[13] != 0x00)) continue;  /* proto == ip */

		/* ip */
		if (hdr->caplen < 14 + sizeof(*ip)) continue;
		ip = (void *)data + 14;
		if (ip->protocol != IPPROTO_TCP) continue;

		/* tcp */
		if (hdr->caplen < 14 + ip->ihl*4 + sizeof(*tcp)) continue;
		tcp = (void *)data + 14 + ip->ihl*4;
		if (!tcp->syn || !tcp->ack) continue;

		//printf("%lu", (unsigned long)(hdr->ts.tv_sec*1000000+hdr->ts.tv_usec));
		//printf(" %d\n", htons(tcp->source));

		//if ((ntohl(ip->daddr)&0xffffff00) == 0x0a1f0300) continue;  // ignore schoolofroot
		if (((ntohl(ip->daddr)>>8)&0xff) != team) continue;

#if 0
		for (i=0; i<P; i++) {
			if (i == 3) continue;
			if (ntohs(tcp->source) == ports[i]) {
				addr = (void *)&ip->daddr;
				printf("0x%08x %d %s\n", ntohl(ip->daddr), ports[i], inet_ntoa(*addr));
			}
		}
#endif
		//if (ntohs(tcp->source) != 0x1b41) continue;  // wwcd

		cur = (hdr->ts.tv_sec/INTERVAL)*INTERVAL;
		if (old+INTERVAL <= cur) {
			if (old) {
				while (old < cur) {
					printf("%lu", old-60*60*7);
					for (i=0; i<C; i++) {
						printf(" %zd", counts[i]);
						counts[i] = 0;
					}
					printf("\n");
					old += INTERVAL;
				}
			}
			old = cur;
		}

		//counts[(unsigned int)ntohl(ip->daddr)>>8 & 0xff]++;
		for (i=0; i<P; i++) {
			if (ntohs(tcp->source) == ports[i]) {
				counts[i]++;
			}
		}
	}

	return EXIT_SUCCESS;
}
